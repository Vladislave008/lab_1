# Лабораторная работа №1 (Вариация М1)

## Цель

Создать консольный калькулятор с помощью логики рекурсивного спуска.
Калькулятор должен выводить результат обработки заданного строкового выражения, состоящего из цифр десятичной системы, операторов + - * ** / // %, круглых скобок, точек и пробелов.

## Правила ввода и допущения

### Правила:
    Строка на входе должна удовлетворять следующим условиям:
    1. Все скобки расставлены попарно, с правильной вложенностью.
    2. Отсутсвует деление нацело/взятия остатка от деления с участием float-операндов (float-операнд с нулевой дробной частью при данных операциях интерпретируется как целочисленный).
    3. Никакие опертаторы не идут друг за другом подряд, они должны быть разделены скобками. Идущие подряд унарные операторы (как и унарные операторы, идущие после каких-либо других) обрабатываются поочередно, но вызывая предупреждение пользователя о возможной оштбке ввода.
    4. Отсутсвуют выражения вида NUM(...) или (...)NUM или (...)(...) или NUM NUM (нет оператора между выражениями).
    5. Отсутсвует деление на ноль.
    6. Все числа во входной строке соответствуют типам int/float.
    7. Входная строка состоит только из цифр десятичной системы, операторов + - * ** / // %, круглых скобок, точек и пробелов.
    8. При возведении в степень правый операнд не превосходит 10**5, иначе ошибка (кроме того, калькулятор может выводить оригинальные ошибки ValueError и OverflowError, сгенерированные python'ом, в случае невозможности обработки и вывода чисел из-за их размеров).

### Допущения:
    1. 0**0 = 1 - допустимо.
    2. .n = 0.n и n. = n.0 - допустимый формат ввода чисел с плавающей точкой.
    3. Если в конечном результате вычислений получено число с плавающей точкой, то оно округляется до двух знаков после точки.

## Структура проекта

В папке [src](./src) содержатся файлы с реализацией задачи, заданной в лабораторной работе.
В файле [main.py](./src/main.py) описана точка входа в приложение - функция main, которая при исполнении файла запускает бесконечный цикл для ввода выражений в консоль и получения результатов. Прервать цикл можно, написав вместо выражения слово "Stop", "End", "Done", "Finish" или "q".
В файле [constants.py](./src/constants.py) содержатся константы (в частности, типы токенов), использующиеся в разных частях проекта.
В файле [calculator_M1.py](./src/calculator_M1.py) содержится класс Token (описывает тип данных, необходимый для представления отдельных частей оригинального выражения) и класс Calculator, в котором содержится:
- Функция tokenize, преобразующая исходное выражение в список объектов типа Token.
- Метод colored_warning, необходимый для улучшения визуализации warning'ов.
- Функция token_correct, необходимая для проверки списка токенов на предмет ошибок.
- Функция evaluate, принимающая выражения в формате строки и выводящая результат вычисления этого выражения.
- Функции primary, unary, pow, mul, add, expr, c помощью которых реализуется логика вычислений в функции evaluate.
В папке [tests] и непосредственно файле [m1_tests.py](./tests/m1_tests.py) содержатся unit-тесты класса Calculator (проверки правильности вычислений, проверки правильного вывода предупреждений и ошибок). Для запуска тестов необходимо выполнить команду pytest m1_tests.py, находясь в папке tests.

## Логика вычислений (логика работы Calculator.evaluate())

Метод рекурсивного спуска подразумевает распределение различных задач обработки выражения (списка токенов) между несколькими функциями.
Функции expr, add, mul, pow, unary и primary вызывают друг друга в соответствии с порядком спуска ("верхний" уровень - expr, "нижний" уровень - primary). Каждая функция вызывает функцию с уровнем ниже на один, чтобы получить аргументы для своей работы (expr - запускает процесс вычисления выражения, add - суммирует произведения, mul - создает произведения из степенных выражений, pow - создает степенные выражения из чисел со знаком, unary - обрабатывает знак чисел, primary - обрабатывает числовые токены и интерпретирует выражения в скобках как числа (с помощью рекурсивного запуска функции expr от выражения внутри скобок)). При этом каждая из данных функций может просто вызвать функцию уровнем ниже, не выполняя собственных вычислений (в случае если на данный момент необходимых аргументов для текущей функции нет). Исключение - функция primary, которая обязана всегда производить вычисления в силу своей нижнеуровневости ("опускаться" из primary некуда).
Все вышеперечисленные функции при надобности работают с атрибутом ind экземпляра класса Calculator, который определяет номер обрабатываемого токена (токены содержатся в списке tokens, также являющимся атрибутом экземпляра класса Calculator). Использование общего счетчика позволяет оптимизировать работу рекурсивных вызовов (вызовы "нижних" функций "двигают" счетчик вперед и "верхняя" функция продолжает работу с того момента, на котором закончила "нижняя" и её более глубокие вызовы).

## Unit-тесты, на которые стоит обратить внимание:
- выражение '0.    5' вызывает SyntaxError('No operator between expressions'), в силу того что токенизатор интерпретирует его как '0.0 5'.
- выражение '4-6*()' вызывает SyntaxError('Bad input format'), так как пустые скобки считаются неверным форматом записи.
- выражение '-2**2' выведет -4 в силу правоассоциативности операции возведения в степень (т.е. сначала возводим в степень, затем применяем унарный минус).
- выражение '-.5+10' корректно выведет результат 9.5 (т.к. токенизатор умеет интерпретировать числа, начинающиеся и заканчивающиеся точкой).

## Запуск модулей
- python -m src.main из корня проекта для запуска главного файла
- python -m pytest tests/m1_tests.py из корня проекта для запуска тестов
